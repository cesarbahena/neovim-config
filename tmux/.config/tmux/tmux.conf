# ============================================================================ 
# TMUX CONFIGURATION
# ============================================================================ 

# ============================================================================ 
# GLOBAL OPTIONS (set -g)
# ============================================================================ 

# True color support
set -g default-terminal "tmux-256color"
set -ag terminal-overrides ",xterm-256color:RGB"

# Faster escape sequences for better vim experience
set -sg escape-time 0

# Focus events for better editor integration
set -g focus-events on

# Enable automatic renaming of windows
setw -g automatic-rename on

set -g base-index 1
set -g renumber-windows on
set -g pane-base-index 1
set -g status-interval 5
set -g history-limit 50000
set -g display-time 4000
set -g aggressive-resize on
set -g mouse on

# ============================================================================ 
# SESSION OPTIONS (set -s)
# ============================================================================ 

# ============================================================================ 
# KEY BINDINGS
# ============================================================================ 

# Set prefix to ` (press twice to literal backtick)
set -g prefix "C-Space"
unbind C-b
bind "C-Space" send-prefix

# Vim detection for smart key bindings
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\S+\/)?g?(view|n?vim?x?)(diff)?$'"

# Workflow shortcuts
bind F5 source-file /home/cesar/dotfiles/tmux/.config/tmux/tmux.conf \; display-message "Config reloaded!"
# Alt+F5 = save & quit all, then restart Neovim
bind -n M-F5 if-shell "pgrep -f 'n?vim' > /dev/null" \
    "send-keys ':wqa' C-m \; run-shell 'sleep 0.2 && tmux send-keys -t #{pane_id} nvim C-m'" \
    "send-keys 'nvim' C-m"
bind \; command-prompt

# Window moving and swapping 
bind -n C-w neww -c "#{pane_current_path}"
bind -n M-m swap-window -t -1 \; select-window -t -1
bind -n M-h swap-window -t +1 \; select-window -t +1
bind -n C-a selectw -t 1
bind -n C-r selectw -t 2
bind -n C-s selectw -t 3
bind -n C-t selectw -t 4
bind -n C-g selectw -t 5
bind -n C-6 selectw -t 6
bind -n C-7 selectw -t 7
bind -n C-8 selectw -t 8
bind -n C-9 selectw -t 9

# Pane creation and management
bind -n C-x run-shell "/home/cesar/dotfiles/tmux/.config/tmux/plugins/tmux-floax/scripts/floax.sh"
bind -n C-d splitw -v -c "#{pane_current_path}"
bind -n C-v splitw -h -c "#{pane_current_path}"
bind -n C-q if-shell \
    'test "#{pane_current_command}" = "$(basename $SHELL)"' \
    'kill-pane' \
    'confirm-before -p "Kill pane running #{pane_current_command}? (y/n)" kill-pane'
bind -n F11 if-shell "$is_vim" "resize-pane -Z \; send-keys F11" "resize-pane -Z"

# Pane navigation (mneo layout)
bind-key -n C-k if-shell "$is_vim" "send C-k" { if -F "#{pane_at_left}" "" "selectp -L" }
bind-key -n C-n if-shell "$is_vim" "send C-n" { if -F "#{pane_at_bottom}" "" "selectp -D" }
bind-key -n C-e if-shell "$is_vim" "send C-e" { if -F "#{pane_at_top}" "" "selectp -U" }
bind-key -n C-o if-shell "$is_vim" "send C-o" { if -F "#{pane_at_right}" "" "selectp -R" }
bind -T copy-mode-vi C-k if -F "#{pane_at_left}" "" "selectp -L"
bind -T copy-mode-vi C-n if -F "#{pane_at_bottom}" "" "selectp -D"
bind -T copy-mode-vi C-e if -F "#{pane_at_top}" "" "selectp -U"
bind -T copy-mode-vi C-o if -F "#{pane_at_right}" "" "selectp -R"

# Pane resizing
bind -n M-Left if-shell "$is_vim" "send-keys M-Left" "resizep -L 5"
bind -n M-Right if-shell "$is_vim" "send-keys M-Right" "resizep -R 5"
bind -n M-Up if-shell "$is_vim" "send-keys M-Up" "resizep -U 5"
bind -n M-Down if-shell "$is_vim" "send-keys M-Down" "resizep -D 5"
bind -T copy-mode-vi M-Left resizep -L 5
bind -T copy-mode-vi M-Right resizep -R 5
bind -T copy-mode-vi M-Up resizep -U 5
bind -T copy-mode-vi M-Down resizep -D 5

# Enter copy mode
bind m copy-mode \; send -X halfpage-up
bind-key -T root WheelUpPane if-shell "$is_vim" "send-keys -M" "copy-mode ; send-keys -X halfpage-up"

# Copy mode commands and selection
bind -T copy-mode-vi v send -X start-selection 
bind -T copy-mode-vi V { send -X back-to-indentation ; send v ; send -X end-of-line }
bind -T copy-mode-vi l send -X other-end 
# Cross-platform clipboard integration
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "if command -v pbcopy > /dev/null; then pbcopy; elif command -v xclip > /dev/null; then xclip -selection clipboard; elif command -v clip.exe > /dev/null; then clip.exe; fi"

# Copy mode movement (Colemak layout)
bind -T copy-mode-vi k send -X cursor-left
bind -T copy-mode-vi n send -X cursor-down
bind -T copy-mode-vi e send -X cursor-up
bind -T copy-mode-vi o send -X cursor-right
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi K send -X back-to-indentation
bind -T copy-mode-vi m send -X halfpage-up 
bind -T copy-mode-vi h send -X halfpage-down
bind -T copy-mode-vi O send -X end-of-line
bind -T copy-mode-vi w send -X next-word
bind -T copy-mode-vi W send -X previous-word
bind -T copy-mode-vi E send -X next-word-end
# bind -T copy-mode-vi T space  send -X previous-space
# bind -T copy-mode-vi t space send -X next-space
# bind -T copy-mode-vi v t space send -X next-space-end

# ============================================================================ 
# STATUS BAR
# ============================================================================ 
set-option -g status-position top
set -g status-style "bg=default bold"
set -g status-justify left
set -g status-left ""
set -g window-status-separator " "
set -g window-status-format "#W"
set -g window-status-current-format "#[fg=brightblue]#W"
set -g status-right "#[align=absolute-centre]    %d    #[fg=brightcyan]#S    #[default]%H:%M#[align=right, default]#{ram_icon}#{ram_percentage}  #{cpu_icon} #{cpu_percentage}  #{battery_icon} #{battery_percentage}"
set -g status-right-length 200

# ============================================================================ 
# PLUGIN MANAGEMENT (TPM)
# ============================================================================ 

# Plugin list
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'  
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-cpu'
# set -g @plugin 'tmux-plugins/tmux-copycat'
set -g @plugin 'Morantron/tmux-fingers'
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'
set -g @plugin 'omerxx/tmux-floax'
set -g @plugin 'omerxx/tmux-sessionx'

# ============================================================================ 
# PLUGIN CONFIGURATION
# ============================================================================ 

# tmux-sessionx: Session management
set-environment -g FZF_DEFAULT_OPTS "--color bg+:-1"
set -g @sessionx-bind 's'

# tmux-resurrect: Save/restore sessions
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-capture-pane-contents 'on'

# tmux-continuum: Auto-save sessions
set -g @continuum-restore 'off'
set -g @continuum-save-interval '15'

# tmux-yank: Enhanced clipboard (Colemak layout)
set -g @yank_selection_mouse 'clipboard'
set -g @yank_with_mouse on

# tmux-prefix-highlight: Show prefix in status bar
set -g @prefix_highlight_fg 'colour0'
set -g @prefix_highlight_bg 'colour84'
set -g @prefix_highlight_show_copy_mode 'on'
set -g @prefix_highlight_copy_mode_attr 'fg=colour0,bg=colour11'

# tmux-battery: Battery status
set -g @batt_icon_status_charged "󰁹"
set -g @batt_icon_status_charging "󰢝"
set -g @batt_icon_status_discharging "󱊢"
set -g @batt_icon_charge_tier8 "󰂂"
set -g @batt_icon_charge_tier7 "󰂀"
set -g @batt_icon_charge_tier6 "󰁿"
set -g @batt_icon_charge_tier5 "󰁾"
set -g @batt_icon_charge_tier4 "󰁽"
set -g @batt_icon_charge_tier3 "󰁼"
set -g @batt_icon_charge_tier2 "󰁻"
set -g @batt_icon_charge_tier1 "󰂃"

# tmux-fingers:
# Add your tmux-fingers configuration here.
set -g @fingers-key 'y'
set -g @fingers-hint-style 'fg=yellow,bg=black,bold'

# tmux-cpu: RAM configuration
set -g @ram_percentage_format "%2.0f%"
set -g @ram_low_icon "\uf4bc "
set -g @ram_medium_icon "\uf4bc "
set -g @ram_high_icon "\uf4bc "
set -g @ram_low_bg_color "#[bg=default]"
set -g @ram_medium_bg_color "#[bg=default]"
set -g @ram_high_bg_color "#[bg=default]"

# tmux-cpu: CPU configuration
set -g @cpu_percentage_format "%3.1f%"
set -g @cpu_low_icon "󰟀"
set -g @cpu_medium_icon "󰟀"
set -g @cpu_high_icon "󰟀"
set -g @cpu_low_bg_color "#[bg=default]"
set -g @cpu_medium_bg_color "#[bg=default]"
set -g @cpu_high_bg_color "#[bg=default]"

# ============================================================================ 
# SOURCING EXTERNAL FILES
# ============================================================================ 
# No explicit source-file commands found in the original content, 
# but this section is reserved if any are added in the future. 
# The tmux-nerd-font-window-name.yml is sourced by the plugin itself.

# Initialize TMUX plugin manager (keep this line at the very bottom)
run '~/.tmux/plugins/tpm/tpm'
